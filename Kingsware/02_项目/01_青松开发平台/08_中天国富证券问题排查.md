###  一. 问题清单

- [x] 1、F5刷新看板时，定时器并没有销毁，多次刷新之后会出现一大堆定时任务在请求；

- [x] 2、看板定时刷新时，Loading效果需要去掉，需要改成类似于静默请求的效果；

- [x] 3、当看板的请求在pending时，页面就无法操作，导致无法切换至其他页面；

- [ ] 4、监控列表接口请求慢，这个需要开发人员调整接口实现逻辑；

- [x]  5、列表数据的页数为200条，下拉出现占位图的情况，客户要求优化；

- [ ] 6、青松去掉加载图标。。[暂时不改，改了之后会出现白屏]

- [ ] 7 、系统信息刷新后为空（数据返回空）的问题





### 二、解决可选方案

1、平台考虑支持按接口进行缓存，另外后台通过定时器拉取数据；

2、客户要求对标的Zabbix，要求实时性。贵哥建议上websocket



### 三、初步结论

1、当前平台由于看板加载和请求问题，会导致整个平台卡住，初步判断定时器处理或实时告警列表渲染处理的问题

2、监控列表接口需要开发人员调整；



### 四、经验总论

####  4.1 场景一

* 问题描述

页面加载时，会出现较长时间的加载过程

* 原因分析

经分析，原先通过uniops转发，会导致青松这边的页面静态资源的缓存失效(js、html、css等)，另外，发现青松的个别的系统数据接口，是属于同步请求，也会造成一定的等待时间；

* 解决方案

1. 由于uniops的转发暂时无法解决，决定上nginx，解决转发导致缓存失效的问题；

2. 系统接口静态化处理（字典、页面、系统配置），即页面请求时，平台拦截请求，处直接将相关数据注入到页面，避免多次网络请求；

####  4.2 场景二

* 问题描述

监控列表列表查询接口查询过慢，现场1000多条数据，响应用时将近5秒；

* 原因分析

经贵哥分析及确认，脚本实现中，主要存在两个原因：

1. 最初版本是进行在内存中分页的，即将所有的数据查询出来，再在内存里进行分页处理；

> 当数据量大之后，会导致进程占用大量的内存，导致程序直接宕机。另外，查询时大量的数据传输需要一定的耗时，同时也对数据存储组件（ES、数据库之类的）造成较大压力，影响系统运行的稳定性；

2. 数据从ES查询出来之后，然后在循环里调用beemq查询数据；

> beemq是一个网络服务，在循环中调用网络请求，包括但不限于数据库操作、Redis操作、http操作、ES操作，当数据量大了之后，会造成这个业务处理用时过长，不满足性能要求，以及对相关组件造成压力；

* 解决方案

1. 查询数据，尽量直接调用数据库或ES的分页，进行物理分页；

2. 面对数据量大的业务时，尽量做到按需查询，比如不直接用*查询所有出来。需要什么数据就查什么即可；

3. 避免发起太多的网络请求，适当进行批量操作。比如上面的原因2，如果数据是分散存储在两个组件，应该进行批量查询（如果现有接口不需要，应提出需求，不要妥协）

####  4.3 场景三

* 问题描述

运维看板实时告警接口、告警统计接口性不能满足客户要求（前期已经对接口进行了优化，但效果仍然不太理想）；

* 解决方案

1. 最初提出，让业务开发人员自行处理，加上缓存处理，避免频繁调用性能较差的接口；系统信息接口也按此方案，进行了处理，但另外两个接口的，涉及到数据权限，处理起来比较麻烦，因此并没有全部都让业务开发处理；
2. 考虑到此类业务的通用性（主要看板类、定时刷新），决定开发平台级的接口缓存功能，即根据请求用户和请求参数计算出唯一标识，创建临时任务在后面进行定时请求，而接口请求这边，直接从内存缓存中读取数据，大大减轻了系统的压力，以及接口的响应速度。

#### 五 衍生需求

1. 平台实现了接口缓存（在接口管理配置），并且通过websocket推送到前端（请求方式还是按接口，平台自动适配）
1. 平台后续提供现场录制功能，将现场的接口请求数据、接口用时、日志信息记录下来，导出压缩包，然后导入到测试环境，进行还原现场。




#### 六 遗留问题

1. 生产环境的看板的queryCurrentAlert接口，目前还是存在性能问题，这个需要业务人员进一步；

